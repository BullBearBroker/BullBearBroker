<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BullBearBroker - Asistente Financiero Inteligente</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- ‚úÖ CONFIGURACI√ìN GLOBAL - DEBE IR PRIMERO -->
    <script src="js/config.js"></script>
</head>
<body>
    <!-- ‚úÖ VERIFICACI√ìN DE AUTENTICACI√ìN -->
    <script src="js/auth.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const authManager = (window.authManager instanceof AuthManager)
            ? window.authManager
            : (window.authManager = new AuthManager());
        
        if (!authManager.isAuthenticated()) {
            window.location.href = 'login.html';
            return;
        }

        // Mostrar informaci√≥n del usuario
        const user = authManager.getUser();
        if (user) {
            // Actualizar UI con info del usuario
            const userInfoElement = document.getElementById('userInfo');
            if (userInfoElement) {
                const createdLabel = user.created_at
                    ? new Date(user.created_at).toLocaleDateString()
                    : '';
                const meta = createdLabel ? `Cuenta creada: ${createdLabel}` : `ID: ${user.id ?? '‚Äî'}`;
                userInfoElement.innerHTML = `
                    <span>${user.email}</span>
                    <small>${meta}</small>
                `;
            }
        }

        // Inicializar el chat despu√©s de verificar autenticaci√≥n
        setTimeout(() => {
            if (typeof initChat === 'function') {
                initChat();
            }
        }, 100);
    });
    </script>

    <!-- Market Header -->
    <div class="market-header">
        <div class="market-ticker" id="liveMarketTicker">
            <!-- Los datos se cargar√°n din√°micamente via WebSocket -->
            <div class="ticker-item">
                <div class="ticker-content">
                    <span class="ticker-name">Cargando datos...</span>
                    <div class="ticker-values">
                        <span class="ticker-price">--</span>
                        <span class="ticker-change">--</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="market-status">
            <div class="status-indicator" id="marketStatusIndicator"></div>
            <span class="status-text" id="marketStatusText">Conectando...</span>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>
                    <i class="fas fa-chart-line"></i>
                    BullBearBroker
                </h2>
                <div class="user-info" id="userInfo">
                    <div class="user-welcome">Bienvenido</div>
                    <div class="user-email">Iniciando sesi√≥n...</div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3><i class="fas fa-star"></i> Watchlist</h3>
                <div class="watchlist-items" id="watchlistItems">
                    <div class="watchlist-item">
                        <div class="item-info">
                            <span class="item-symbol">BTC</span>
                            <span class="item-name">Bitcoin</span>
                        </div>
                        <div class="item-values">
                            <span class="item-price" id="btcPrice">Cargando...</span>
                            <span class="item-change" id="btcChange">--</span>
                        </div>
                    </div>
                    <div class="watchlist-item">
                        <div class="item-info">
                            <span class="item-symbol">ETH</span>
                            <span class="item-name">Ethereum</span>
                        </div>
                        <div class="item-values">
                            <span class="item-price" id="ethPrice">Cargando...</span>
                            <span class="item-change" id="ethChange">--</span>
                        </div>
                    </div>
                    <div class="watchlist-item">
                        <div class="item-info">
                            <span class="item-symbol">AAPL</span>
                            <span class="item-name">Apple Inc.</span>
                        </div>
                        <div class="item-values">
                            <span class="item-price" id="aaplPrice">Cargando...</span>
                            <span class="item-change" id="aaplChange">--</span>
                        </div>
                    </div>
                </div>
                <button class="sidebar-btn" onclick="showAddToWatchlist()">
                    <i class="fas fa-plus"></i> A√±adir a Watchlist
                </button>
            </div>

            <div class="sidebar-section">
                <h3><i class="fas fa-bell"></i> Alertas Activas</h3>
                <div class="alerts-list" id="alertsList">
                    <div class="empty-state">Cargando alertas...</div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3><i class="fas fa-fire"></i> Top Performers</h3>
                <div class="ticker-list" id="topTickers">
                    <div class="loading-text">Cargando datos en tiempo real...</div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3><i class="fas fa-arrow-down"></i> Worst Performers</h3>
                <div class="ticker-list" id="worstTickers">
                    <div class="loading-text">Cargando datos en tiempo real...</div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3><i class="fas fa-zap"></i> Acciones R√°pidas</h3>
                <button class="quick-btn" onclick="askQuestion('Analiza el mercado de Bitcoin')">
                    <i class="fab fa-bitcoin"></i> An√°lisis BTC
                </button>
                <button class="quick-btn" onclick="askQuestion('Qu√© acciones recomiendas hoy?')">
                    <i class="fas fa-chart-bar"></i> Stocks Recomendados
                </button>
                <button class="quick-btn" onclick="askQuestion('Mostrar estrategias conservadoras')">
                    <i class="fas fa-shield-alt"></i> Estrategias
                </button>
                <button class="quick-btn" onclick="showMarketOverview()">
                    <i class="fas fa-globe-americas"></i> Visi√≥n General
                </button>
                <button class="quick-btn" onclick="showOrderbook('BTC')">
                    <i class="fas fa-book"></i> Orderbook BTC
                </button>
                <button class="quick-btn" onclick="authManager.logout()" style="background: #e74c3c;">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                </button>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-content">
            <div class="chat-header">
                <div class="header-info">
                    <h1>
                        <i class="fas fa-robot"></i>
                        Asistente Financiero
                    </h1>
                    <p>Conectado a mercados en tiempo real ‚Ä¢ <span id="connectionStatusText">Conectando...</span></p>
                </div>
                <div class="header-actions">
                    <button class="action-btn" onclick="clearChat()">
                        <i class="fas fa-trash"></i> Limpiar
                    </button>
                    <button class="action-btn" onclick="exportChat()">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                    <button class="action-btn" onclick="showAlertModal()">
                        <i class="fas fa-bell"></i> Alertas
                    </button>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message ai-message">
                    <div class="message-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-sender">BullBearBroker AI</div>
                        <div class="message-text">
                            ¬°Hola! Soy tu asistente especializado en mercados financieros. 
                            Conectado a <strong>datos en tiempo real</strong> de Binance y mercados globales.
                            <br><br>
                            <strong>¬øEn qu√© te puedo ayudar hoy?</strong>
                            <br><br>
                            üí° <em>Puedes preguntarme sobre precios, an√°lisis t√©cnico, estrategias de inversi√≥n y m√°s.</em>
                        </div>
                        <div class="message-time" id="currentTime">Justo ahora</div>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="input-actions">
                    <button class="input-btn" onclick="addQuickQuestion('Precio de Bitcoin')">
                        <i class="fab fa-bitcoin"></i>
                    </button>
                    <button class="input-btn" onclick="addQuickQuestion('An√°lisis del mercado')">
                        <i class="fas fa-chart-line"></i>
                    </button>
                    <button class="input-btn" onclick="addQuickQuestion('Noticias de trading')">
                        <i class="fas fa-newspaper"></i>
                    </button>
                    <button class="input-btn" onclick="addQuickQuestion('Tendencias del d√≠a')">
                        <i class="fas fa-trending-up"></i>
                    </button>
                    <button class="input-btn" onclick="showOrderbook('BTC')">
                        <i class="fas fa-book"></i>
                    </button>
                </div>
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        placeholder="Preg√∫ntame sobre precios, an√°lisis t√©cnico, estrategias de inversi√≥n..."
                        rows="1"
                        onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                    ></textarea>
                    <button class="send-button" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i> Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas Toast -->
    <div id="alertContainer" class="alert-container"></div>

    <!-- Modal para Configurar Alertas -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configurar Alerta</h3>
                <span class="close" onclick="closeModal('alertModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Activo</label>
                    <input type="text" id="alertSymbol" placeholder="Ej: BTC, AAPL, ETH" />
                </div>
                <div class="form-group">
                    <label>Condici√≥n</label>
                    <select id="alertCondition">
                        <option value="above">Por encima de</option>
                        <option value="below">Por debajo de</option>
                        <option value="change">Cambio % mayor a</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Valor</label>
                    <input type="number" id="alertValue" placeholder="0.00" step="0.01" />
                </div>
                <div class="form-error" id="alertFormError" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('alertModal')">Cancelar</button>
                <button class="btn-primary" onclick="saveAlert()">Guardar Alerta</button>
            </div>
        </div>
    </div>

    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status connecting">
        <div class="status-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </div>
        <span>Conectando a datos en tiempo real...</span>
    </div>

    <!-- ‚úÖ ORDEN CORRECTO DE SCRIPTS -->
    <script src="js/api.js"></script>
    <script src="js/market-data.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/ui-components.js"></script>
    
    <!-- ‚úÖ FIX PARA UI-COMPONENTS -->
    <script src="js/fix-ui.js"></script>
    
    <!-- ‚úÖ EMERGENCY FIX (SOLUCI√ìN DE EMERGENCIA) -->
    <script src="js/emergency-fix.js"></script>

    <script>
    // Actualizar hora actual
    function updateCurrentTime() {
        const now = new Date();
        document.getElementById('currentTime').textContent = now.toLocaleTimeString();
    }
    
    // Inicializar la aplicaci√≥n
    function initApp() {
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        
        // Inicializar el chat si est√° disponible
        if (typeof initChat === 'function') {
            initChat();
        }
        
        console.log('‚úÖ BullBearBroker inicializado correctamente');
        
        // Verificar conectividad
        setTimeout(() => {
            if (window.checkConnectivity) {
                window.checkConnectivity();
            }
        }, 3000);
    }

    // Inicializar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initApp);
    } else {
        initApp();
    }
    </script>
</body>
</html>
